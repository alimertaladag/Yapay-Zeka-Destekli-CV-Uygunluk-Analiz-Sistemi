import os
import tempfile
import re
from flask import Flask, request, redirect, url_for
import spacy
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.metrics.pairwise import cosine_similarity
import PyPDF2

# --- 1. Uygulama AyarlarÄ± ve Modeller ---
app = Flask(__name__)

# Flask iÃ§in dosya yÃ¼kleme ayarlarÄ±
app.config['MAX_CONTENT_LENGTH'] = 16 * 1024 * 1024  # 16MB limit
ALLOWED_EXTENSIONS = {'pdf'}
MIN_JOB_DESC_LENGTH = 50  # Minimum ilan metni uzunluÄŸu

# SpaCy dil modelini yÃ¼kle (Ä°ngilizce CV'ler iÃ§in temel model)
try:
    # Modelin yÃ¼klenmesi kritik olduÄŸu iÃ§in globalde tutuyoruz
    nlp = spacy.load("en_core_web_sm")
    print("SpaCy modeli baÅŸarÄ±yla yÃ¼klendi.")
except OSError:
    print(
        "HATA: SpaCy 'en_core_web_sm' modeli bulunamadÄ±. LÃ¼tfen terminalde 'python -m spacy download en_core_web_sm' komutunu Ã§alÄ±ÅŸtÄ±rÄ±n.")
    exit()

# --- 2. YardÄ±mcÄ± Fonksiyonlar (NLP ve Skorlama) ---

# CV'de aradÄ±ÄŸÄ±mÄ±z genel TÃ¼rkÃ§e/Ä°ngilizce baÅŸlÄ±klar (YapÄ±sal puanlama iÃ§in)
CV_HEADERS_TR_EN = {
    'experience': ['deneyim', 'experience', 'iÅŸ tecrÃ¼besi'],
    'education': ['eÄŸitim', 'education', 'okul'],
    'skills': ['beceriler', 'skills', 'yetenekler'],
    'projects': ['projeler', 'projects'],
    'contact': ['iletiÅŸim', 'contact', 'telefon', 'email']
}


def allowed_file(filename):
    """Dosya uzantÄ±sÄ±nÄ±n izin verilen listede olup olmadÄ±ÄŸÄ±nÄ± kontrol eder."""
    return '.' in filename and \
        filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS


def extract_text_from_pdf(pdf_path):
    """PyPDF2 kullanarak PDF dosyasÄ±ndan metin Ã§Ä±karÄ±r."""
    text = ""
    try:
        with open(pdf_path, 'rb') as file:
            reader = PyPDF2.PdfReader(file)
            for page in reader.pages:
                text += page.extract_text() or ''
    except Exception as e:
        print(f"PDF okuma hatasÄ±: {e}")
        return None
    return text.strip()


def preprocess_and_extract_keywords(text):
    """
    Metni Ã¶n iÅŸler, anahtar kelimeleri Ã§Ä±karÄ±r ve kÃ¶klerini (lemma) dÃ¶ndÃ¼rÃ¼r.
    """
    if not text:
        return []

    text = text.lower()
    doc = nlp(text)

    keywords = []

    for token in doc:
        # Stop words, noktalama iÅŸaretleri, boÅŸluklar, sayÄ±lar ve kÄ±sa kelimeleri atla
        is_junk = token.is_stop or token.is_punct or token.is_space or token.like_num or len(token.text) < 2
        # Sadece Ä°sim (NOUN), SÄ±fat (ADJ) ve Fiilleri (VERB) tut
        is_relevant_pos = token.pos_ in ['NOUN', 'ADJ', 'VERB']

        if not is_junk and is_relevant_pos:
            keywords.append(token.lemma_)

    return keywords


def calculate_structural_score(raw_cv_text):
    """
    CV'nin uzunluÄŸunu, sayfa sayÄ±sÄ±nÄ± ve ana baÅŸlÄ±klarÄ±n varlÄ±ÄŸÄ±nÄ± analiz ederek
    gÃ¶rsel ve yapÄ±sal kalitesini simÃ¼le eder. (0-100 arasÄ±nda bir puan)
    """
    score = 0
    text_length = len(raw_cv_text)

    # 1. Uzunluk PuanÄ± (Max 30 Puan)
    # Optimum uzunluk: 500-2000 karakter arasÄ± (1-2 sayfa PDF)
    if 500 <= text_length <= 2500:
        score += 30
    elif 200 <= text_length < 500 or 2500 < text_length <= 4000:
        score += 15

    # 2. Ana BaÅŸlÄ±k VarlÄ±ÄŸÄ± PuanÄ± (Max 70 Puan)
    # CV'nin dÃ¼zenli ve yapÄ±landÄ±rÄ±lmÄ±ÅŸ olduÄŸunu varsayÄ±yoruz
    found_headers = set()
    raw_text_lower = raw_cv_text.lower()

    # Her ana kategori iÃ§in (deneyim, eÄŸitim, beceriler) CV'yi kontrol et
    for category, headers in CV_HEADERS_TR_EN.items():
        for header in headers:
            # BaÅŸÄ±na ve sonuna boÅŸluk/satÄ±r sonu eklemek, kelimenin tam baÅŸlÄ±k olduÄŸunu varsayarÄ±z.
            if re.search(r'\b' + re.escape(header) + r'\b', raw_text_lower):
                found_headers.add(category)
                break

    # Bulunan baÅŸlÄ±k sayÄ±sÄ±na gÃ¶re puanlama (Max 5 kategori * 14 puan)
    score += len(found_headers) * 14

    # Nihai yapÄ±sal puanÄ± 0-100 arasÄ±nda normalize et
    return min(100, max(0, score))


def calculate_similarity_score(cv_keywords, job_keywords):
    """
    Sadece anahtar kelime uygunluÄŸunu (NLP) hesaplar. (0-100 arasÄ±nda bir puan)
    """
    if not cv_keywords or not job_keywords:
        return 0, [], []

    cv_text = ' '.join(cv_keywords)
    job_text = ' '.join(job_keywords)

    vectorizer = TfidfVectorizer()
    corpus = [cv_text, job_text]
    tfidf_matrix = vectorizer.fit_transform(corpus)

    cosine_sim = cosine_similarity(tfidf_matrix[0:1], tfidf_matrix[1:2])[0][0]

    cv_set = set(cv_keywords)
    job_set = set(job_keywords)

    matching_keywords = sorted(list(cv_set.intersection(job_set)))
    missing_keywords = sorted(list(job_set.difference(cv_set)))

    score = round(cosine_sim * 100, 2)

    return score, matching_keywords, missing_keywords


# --- 3. HTML ÅablonlarÄ± (Basit, Jinja'sÄ±z) ---

def generate_base_html(content):
    """TÃ¼m sayfalar iÃ§in ana HTML yapÄ±sÄ±nÄ± oluÅŸturur."""
    return f"""
    <!DOCTYPE html>
    <html lang="tr">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>CV Analiz Sistemi - GÃ¶rÃ¼ntÃ¼/YapÄ±sal Puanlama</title>
        <!-- Tailwind CSS CDN -->
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
            body {{
                font-family: 'Inter', sans-serif;
                background-color: #f3f4f6;
            }}
        </style>
    </head>
    <body class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-4xl bg-white shadow-2xl rounded-xl p-8 md:p-10 border border-gray-200">
            <h1 class="text-3xl font-extrabold text-gray-900 mb-8 text-center border-b pb-4">
                ğŸ‘ï¸ Yapay Zeka Destekli CV Uygunluk Puanlama (YapÄ±sal OdaklÄ±)
            </h1>
            {content}
        </div>
    </body>
    </html>
    """


def generate_index_content(error=None):
    """Ana sayfa form iÃ§eriÄŸini oluÅŸturur."""
    error_html = ""
    if error:
        error_html = f"""
        <div class="mt-4 p-3 bg-red-100 text-red-700 rounded-lg font-medium text-sm border border-red-300">
            ğŸš¨ Hata: {error}
        </div>
        """

    return f"""
    <div class="text-center mb-8">
        <p class="text-gray-600">CV'niz hem iÃ§erik hem de yapÄ±sal dÃ¼zen aÃ§Ä±sÄ±ndan (gÃ¶rÃ¼ntÃ¼ simÃ¼lasyonu) deÄŸerlendirilecektir.</p>
    </div>

    <form method="POST" action="{url_for('analyze')}" enctype="multipart/form-data" class="space-y-6">

        <!-- 1. Ä°ÅŸ Ä°lanÄ± Metni GiriÅŸi -->
        <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-200">
            <label for="job_description" class="block text-lg font-bold text-indigo-800 mb-2">1. Ä°ÅŸ Ä°lanÄ± Metni</label>
            <textarea name="job_description" id="job_description" rows="6" required
                      placeholder="Ä°ÅŸ ilanÄ±nÄ±n metnini buraya yapÄ±ÅŸtÄ±rÄ±n..."
                      class="w-full p-3 border border-indigo-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 shadow-inner text-gray-700"></textarea>
        </div>

        <!-- 2. CV DosyasÄ± YÃ¼kleme -->
        <div class="bg-green-50 p-4 rounded-lg border border-green-200">
            <label for="file" class="block text-lg font-bold text-green-800 mb-2">2. PDF CV DosyasÄ±</label>
            <input type="file" name="file" id="file" required accept=".pdf" 
                   class="block w-full text-base text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-100 file:text-green-700 hover:file:bg-green-200 cursor-pointer">
        </div>

        <button type="submit" 
                class="w-full py-3 px-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg shadow-md transition duration-200">
            Analizi BaÅŸlat (YapÄ± + Ä°Ã§erik)
        </button>
    </form>
    {error_html}
    """


def generate_result_content(final_score, keyword_score, structural_score, matching_keywords, missing_keywords):
    """SonuÃ§ sayfasÄ±nÄ±n iÃ§eriÄŸini Python'da dinamik olarak oluÅŸturur."""

    # EÅŸleÅŸen kelimeleri HTML'e Ã§evir
    matching_list_html = "".join(
        [f'<span class="px-2 py-0.5 bg-green-100 text-green-700 rounded-full">{k}</span>' for k in matching_keywords])
    if not matching_keywords:
        matching_list_html = '<p class="text-gray-500 italic text-sm">HiÃ§bir anahtar kelime eÅŸleÅŸmesi bulunamadÄ±.</p>'

    # Eksik kelimeleri HTML'e Ã§evir
    missing_list_html = "".join(
        [f'<span class="px-2 py-0.5 bg-red-100 text-red-700 rounded-full">{k}</span>' for k in missing_keywords])
    if not missing_keywords:
        missing_list_html = '<p class="text-gray-500 italic text-sm">CV\'niz, ilanÄ±n tÃ¼m Ã¶nemli becerilerini kapsÄ±yor!</p>'

    return f"""
    <div class="text-center mb-6">
        <h2 class="text-2xl font-bold text-indigo-700">âœ… Analiz SonuÃ§larÄ±</h2>
        <p class="text-sm text-gray-500 mt-1">Nihai Puan = (%80 Ä°Ã§erik UygunluÄŸu) + (%20 YapÄ±sal Kalite)</p>
    </div>

    <!-- Nihai Puan -->
    <div class="bg-indigo-50 p-6 rounded-lg shadow-inner mb-6 text-center border border-indigo-200">
        <p class="text-xl font-semibold text-gray-700 mb-2">NÄ°HAÄ° UYGUNLUK PUANI</p>
        <p class="text-6xl font-black text-indigo-600">{final_score}%</p>
        <div class="mt-4 w-full bg-indigo-200 rounded-full h-3">
            <div class="bg-indigo-600 h-3 rounded-full" style="width: {final_score}%"></div>
        </div>
    </div>

    <!-- Alt Puanlar -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
        <div class="p-4 rounded-lg bg-blue-50 border border-blue-200 text-center">
            <h3 class="text-lg font-bold text-blue-700">Ä°Ã§erik UygunluÄŸu (NLP)</h3>
            <p class="text-4xl font-black text-blue-600">{keyword_score}%</p>
            <p class="text-xs text-gray-500">Ä°lan kelimelerine ne kadar benzediÄŸi.</p>
        </div>
        <div class="p-4 rounded-lg bg-yellow-50 border border-yellow-200 text-center">
            <h3 class="text-lg font-bold text-yellow-700">YapÄ±sal Kalite (SimÃ¼lasyon)</h3>
            <p class="text-4xl font-black text-yellow-600">{structural_score}%</p>
            <p class="text-xs text-gray-500">CV uzunluÄŸu ve ana baÅŸlÄ±k dÃ¼zeni (GÃ¶rÃ¼ntÃ¼ SimÃ¼lasyonu).</p>
        </div>
    </div>

    <div class="space-y-4">
        <!-- EÅŸleÅŸen Anahtar Kelimeler -->
        <div class="p-4 rounded-lg bg-green-50 border border-green-200">
            <h3 class="text-lg font-semibold text-green-700 mb-2">ğŸ¯ EÅŸleÅŸen Kelimeler ({len(matching_keywords)})</h3>
            <div class="flex flex-wrap gap-2 text-sm">
                {matching_list_html}
            </div>
        </div>

        <!-- Eksik Anahtar Kelimeler -->
        <div class="p-4 rounded-lg bg-red-50 border border-red-200">
            <h3 class="text-lg font-semibold text-red-700 mb-2">âš ï¸ Eksik Kelimeler ({len(missing_keywords)})</h3>
            <div class="flex flex-wrap gap-2 text-sm">
                {missing_list_html}
            </div>
        </div>
    </div>

    <div class="mt-6 text-center">
        <a href="{url_for('index')}" class="inline-block py-2 px-6 bg-gray-600 hover:bg-gray-700 text-white font-medium rounded-lg transition duration-150">
            Yeni Analiz Yap
        </a>
    </div>
    """


# --- 4. Flask YÃ¶nlendiriciler (Routes) ---

@app.route('/', methods=['GET'])
def index():
    """Ana sayfa: Ä°ÅŸ Ä°lanÄ± metni ve PDF yÃ¼kleme formunu gÃ¶sterir."""
    content = generate_index_content(error=None)
    return generate_base_html(content)


@app.route('/analyze', methods=['POST'])
def analyze():
    """YÃ¼klenen dosyayÄ± ve ilan metnini alÄ±r, analiz eder ve sonucu gÃ¶sterir."""

    file = request.files.get('file')
    job_description = request.form.get('job_description', '')

    # GiriÅŸ Kontrolleri
    if not file or file.filename == '':
        return generate_base_html(generate_index_content(error="LÃ¼tfen CV dosyanÄ±zÄ± yÃ¼kleyin."))

    if not job_description or len(job_description) < MIN_JOB_DESC_LENGTH:
        return generate_base_html(generate_index_content(
            error=f"LÃ¼tfen en az {MIN_JOB_DESC_LENGTH} karakter uzunluÄŸunda bir Ä°ÅŸ Ä°lanÄ± Metni girin."))

    if not allowed_file(file.filename):
        return generate_base_html(
            generate_index_content(error="GeÃ§ersiz dosya uzantÄ±sÄ±. LÃ¼tfen sadece PDF dosyasÄ± yÃ¼kleyin."))

    # Dosya Ä°ÅŸleme
    with tempfile.NamedTemporaryFile(suffix=".pdf", delete=False) as temp_file:
        temp_path = temp_file.name
        file.save(temp_path)

    try:
        # 1. Metin Ã‡Ä±karma (CV)
        raw_cv_text = extract_text_from_pdf(temp_path)

        if not raw_cv_text or len(raw_cv_text.strip()) < 50:
            return generate_base_html(generate_index_content(
                error="PDF'ten anlamlÄ± metin Ã§Ä±karÄ±lamadÄ±. Dosya taranmÄ±ÅŸ bir gÃ¶rsel/resim CV olabilir."))

        # 2. Anahtar Kelime Ã‡Ä±karma
        cv_keywords = preprocess_and_extract_keywords(raw_cv_text)
        job_keywords = preprocess_and_extract_keywords(job_description)

        if not job_keywords:
            return generate_base_html(generate_index_content(
                error="Ä°lan metninden anlamlÄ± anahtar kelime (isim, sÄ±fat, fiil) Ã§Ä±karÄ±lamadÄ±. Daha detaylÄ± bir ilan metni kullanÄ±n."))

        # 3. Alt PuanlarÄ± Hesaplama
        keyword_score, matching_keywords, missing_keywords = calculate_similarity_score(cv_keywords, job_keywords)
        structural_score = calculate_structural_score(raw_cv_text)

        # 4. Nihai PuanÄ± Hesaplama (AÄŸÄ±rlÄ±klandÄ±rma)
        # Ä°Ã§erik daha Ã¶nemli olduÄŸu iÃ§in %80, YapÄ±sal Puan (GÃ¶rÃ¼ntÃ¼ SimÃ¼lasyonu) %20 aÄŸÄ±rlÄ±k veriyoruz.
        final_score = round((keyword_score * 0.80) + (structural_score * 0.20), 2)

        # 5. SonuÃ§larÄ± Sunma (DoÄŸrudan HTML stringi dÃ¶ndÃ¼r)
        content = generate_result_content(final_score, keyword_score, structural_score, matching_keywords,
                                          missing_keywords)
        return generate_base_html(content)

    except Exception as e:
        print(f"Genel analiz hatasÄ±: {e}")
        return generate_base_html(generate_index_content(error=f"Analiz sÄ±rasÄ±nda beklenmeyen bir hata oluÅŸtu: {e}"))
    finally:
        # GeÃ§ici dosyayÄ± siliyoruz
        os.remove(temp_path)


if __name__ == '__main__':
    print("--- CV Analiz Sistemi BaÅŸlatÄ±lÄ±yor ---")
    app.run(debug=True)
